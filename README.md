# Caplin Platform Diagnostics

Caplin Platform Diagnostics is a collection of Bash scripts that collect diagnostics on a running or crashed Caplin Platform component.

The scripts automate a series of common Linux diagnostic commands that Caplin Support ask customers to run when raising a support request.

Caplin Platform Diagnostics is made available under an MIT licence.



## caplin-process-diagnostics.sh

This script collates diagnostic information for a running Caplin component. It does not terminate the component's process.

Diagnostics collected include a core dump, thread backtraces, and JVM diagnostics (if the component has a JVM).

Run this script when requested by Caplin Support, and upload the following files to Caplin's secure [File Upload Facility](https://www.caplin.com/account/uploads):

*   Diagnostic archive generated by `caplin-process-diagnostics.sh`
*   Java virtual machine log files (if available):
    *   Garbage collection log (`var/gc.log`)
*   Caplin log files for the period of the incident
*   Caplin configuration files

### Requirements

The most useful diagnostic commands run by this script require the GNU Debugger and root privileges.

**Required**:

*   Red Hat Enterprise Linux 6/7
*   Write permission to the current directory

**Recommended**:

*   GNU Debugger (`gdb` package). Required for GDB backtraces and GDB core dump.
*   `strace` package. Required for system-call logging.
*   JDK utility `jcmd` in your executable path. Required for JVM diagnostics.
*   Free disk space greater than the sum of the process's virtual memory and the process's JVM heap. Required for the GDB core dump and the JVM heap dump.

### Usage

The script takes one command-line argument.

**Usage**: `caplin-process-diagnostics.sh <process-id>`

*   `<process-id>`: process ID of the running component

**Run as**:

*   **RHEL 6**: root or process user
*   **RHEL 7**:
    *   **kernel.yama.ptrace_scope=0**: root or process user
    *   **kernel.yama.ptrace_scope=1**: root
    *   **kernel.yama.ptrace_scope=2**: root
    *   **kernel.yama.ptrace_scope=3**: _GDB core dumps, GDB backtraces, and strace prohibited_

**Runtime**: 5 minutes

**Output**: `diagnostics-<hostname>-<binary>-<pid>-<timestamp>.tar.gz`

### Information collated

This script collates the following information:

| Diagnostic                                  | Dependencies     | User |
|---------------------------------------------|------------------|------|
| OS version                                  | -                | -    |
| `top` output for the system                 | -                | -    |
| `top` output for the process                | -                | -    |
| `df` output (disk space)                    | -                | -    |
| `free` output (memory usage)                | -                | -    |
| `vmstat` output                             | -                | -    |
| Caplin Deployment Framework (`dfw`) reports | -                | -    |
| JVM statistics, heap dump, and stack trace  | `jcmd` command   | root or process user |
| `strace` output (system-call log)           | `strace` package | root or process user (see _Note 1_) |
| GDB thread backtraces                       | `gdb` package    | root or process user (see _Note 1_) |
| GDB core-file dump                          | `gdb` package    | root or process user (see _Note 1_) |
| Core-file backtrace                         | `gdb` package    | -    |
| Core-file libraries                         | `gdb` package    | -    |
| Process binary                              | -                | -    |

**Note 1**: from Red Hat Enterprise Linux 7, permission to attach to running processes is controlled by the `kernel.yama.ptrace_scope` system control setting. To check the current `ptrace_scope` setting, run the command `sysctl kernel.yama.ptrace_scope`. For the meaning of individual `ptrace_scope` values, see <https://www.kernel.org/doc/Documentation/security/Yama.txt>

### Example usage

The example below collates diagnostics for a Liberator running as process 4972:

```console
$ sudo ./caplin-process-diagnostics.sh 4972

Caplin Process Diagnostics
==========================

Expected runtime 5 minutes

Process ID:      4972
Process binary:  /home/caplin/dfw1/kits/Liberator/Liberator-7.1.9-313149/bin/rttpd

Script user:     root
Script temp dir: ./diagnostics-server1-rttpd-4972-20190916102608

Recording OS version
Recording /proc/sys/kernel/core_pattern
Recording /proc/sys/kernel/core_uses_pid
Recording 'top' output (1 minute)
Recording 'top' output for process 4972 (1 minute)
Recording process 4972 limits (/proc/4972/limits)
Recording 'df' output for /home/caplin/dfw1/servers/Liberator/var
Recording 'free' output
Recording 'vmstat' output (30 seconds)
Recording 'dfw info' output
Recording 'dfw status' output
Recording 'dfw versions' output
1/3: Dumping GDB thread backtraces for process 4972
  Sleeping for 10 seconds...
2/3: Dumping GDB thread backtraces for process 4972
  Sleeping for 10 seconds...
3/3: Dumping GDB thread backtraces for process 4972
Recording JVM stack trace
Recording JVM heap info
Recording JVM heap
  Estimated heap-file size: 19MB
  Available disk space: 20793MB
Recording JVM properties
Recording JVM flags
Recording JVM performance counters
Recording JVM jstat GC output
Logging system calls for process 4972 (30 seconds)
Recording GDB core file
  Estimated core-file size: 2778MB
  Available disk space: 20770MB
  Core dumped to rttpd.core.4972
  Getting thread backtraces from rttpd.core.4972
  Getting list of libraries referenced by rttpd.core.4972
  Copying libraries referenced by rttpd.core.4972
Creating symbolic link to process's binary

DONE

Files collected:
  df.out
  dfw-info.out
  dfw-status.out
  dfw-versions.out
  diagnostics.log
  free.out
  jvm-flags
  jvm-heap.hprof
  jvm-heapinfo
  jvm-jstat-gc
  jvm-jstat-gcutil
  jvm-perfcounter
  jvm-props
  jvm-stacktrace
  libs-list.out
  libs-list.txt
  os-release
  proc-4972-limits
  proc-sys-kernel-core_pattern
  proc-sys-kernel-core_uses_pid
  redhat-release
  rttpd
  rttpd-backtrace-20190916102843.out
  rttpd-backtrace-20190916102854.out
  rttpd-backtrace-20190916102904.out
  rttpd.core.4972
  rttpd.core.4972.backtrace.out
  rttpd.core.4972.libs.tar
  rttpd-strace.4972
  rttpd-strace.4977
  rttpd-strace.4978
  rttpd-strace.4981
  rttpd-strace.4982
  rttpd-strace.4983
  rttpd-strace.4984
  rttpd-strace.4985
  rttpd-strace.4986
  rttpd-strace.4987
  rttpd-strace.4988
  rttpd-strace.5006
  rttpd-strace.5015
  rttpd-strace.5018
  rttpd-strace.5019
  rttpd-strace.5020
  rttpd-strace.5026
  rttpd-strace.5031
  rttpd-strace.5267
  rttpd-top.out
  top.out
  uname.out
  vmstat.out

Archiving files to diagnostics-server1-rttpd-4972-20190916102608.tar.gz

Please login to https://www.caplin.com/account/uploads
and upload the archive to Caplin Support.

```



## caplin-core-diagnostics.sh

This script collates diagnostic information for a core file dumped by a crashed Caplin component.

Run this script when requested by Caplin Support, and upload the following files to Caplin's secure [File Upload Facility](https://www.caplin.com/account/uploads):

*   Diagnostic archive generated by `caplin-core-diagnostics.sh`
*   Java virtual machine log and error files (if available):
    *   HotSpot JVM error file (`hs_err_pid<process-id>.log`)
    *   Heap dump file (`var/java_pid<process-id>.hprof`)
    *   Garbage collection log (`var/gc.log`)
*   Caplin log files for the period of the incident
*   Caplin configuration files

### Requirements

This script has the following requirements:

*   Red Hat Enterprise Linux 6/7
*   GNU Debugger (`gdb` package)
*   Write permission to the current directory
*   Run on the crashed component's host or on an identically configured host

### Usage

The script takes two command-line arguments.

**Usage**: `caplin-process-diagnostics.sh <binary> <core-file>`

*   `<binary>`: path to the crashed process's binary
*   `<core-file>`: path to the core-file dumped by the crashed process

**Run as**: any user

**Runtime**: < 1 minute

**Output**: `diagnostics-<hostname>-<core-file>-<timestamp>.tar.gz`

### Information collated

This script collates the following information:

| Diagnostic                                   | Dependencies     | User |
|----------------------------------------------|------------------|------|
| OS version                                   | -                | -    |
| Caplin Deployment Framework 'version' report | -                | -    |
| Core file                                    | -                | -    |
| Core file backtrace                          | `gdb` package    | -    |
| Core file libraries                          | `gdb` package    | -    |
| Component binary                             | -                | -    |

### Example usage

The example below collates diagnostics for a core file, `core.4972`, dumped by a Liberator binary, `rttpd`:

```console
$ ./caplin-core-diagnostics.sh ~/dfw1/servers/Liberator/bin/rttpd ~/dfw1/servers/Liberator/core.4972

Caplin Core-file Diagnostics
============================

Script temp dir: diagnostics-server1-rttpd-core.4972-20190916104354

Recording OS version
Recording 'dfw versions' output
Getting thread backtraces from core.4972
Getting list of libraries referenced by core.4972
Copying libraries referenced by core.4972

DONE

Files collected:

  core.4972
  core.4972.backtrace.out
  core.4972.libs.tar
  dfw-versions.out
  diagnostics.log
  libs-list.out
  libs-list.txt
  os-release
  redhat-release
  rttpd
  uname.out

Archiving files to diagnostics-server1-rttpd-core.4972-20190916104354.tar.gz

Please login to https://www.caplin.com/account/uploads
and upload the archive to Caplin Support.

```
