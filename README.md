# Caplin Platform Diagnostics

Caplin Platform Diagnostics is a collection of Bash scripts that collect diagnostics on a running or crashed Caplin Platform component.

The scripts automate a series of common Linux diagnostic commands that Caplin Support ask customers to run when raising a support request.

Caplin Platform Diagnostics is made available under an MIT licence.


## caplin-core-diagnostics.sh

Collates diagnostics for a crashed Caplin component that has dumped a core file.

The diagnostics collated include all the files Caplin Support require to analyse the core file: the component binary, the core file, and all shared libraries referenced in the core file. For the full list of information collated, see [Information collated](#information-collated), below.

After running the script, log in to Caplin's secure [File Upload Facility](https://www.caplin.com/account/uploads) and upload the following files:

*   Tar archive generated by the `caplin-core-diagnostics.sh` script
*   Java virtual machine log and error files (if available):
    *   HotSpot JVM error file (`hs_err_pid<process-id>.log`)
    *   Heap dump file (`var/java_pid<process-id>.hprof`)
    *   Garbage collection log (`var/gc.log`)
*   Caplin log files for the period of the incident
*   Caplin configuration files

### Requirements

This script has the following requirements:

*   [CentOS](https://www.centos.org/)/[RHEL](https://www.redhat.com/en/technologies/linux-platforms/enterprise-linux) 6 or 7
*   GNU Debugger (`gdb` RPM package)
*   Write permission to the current directory
*   Run on the crashed component's host or on an identically configured host

### Usage

**Syntax**: `caplin-process-diagnostics.sh <binary> <core-file>`

*   `<binary>`: path to the crashed process's binary
*   `<core-file>`: path to the core-file dumped by the crashed process

**Run as**: any user

**Runtime**: < 1 minute

**Output**: `diagnostics-<hostname>-<core-file>-<timestamp>.tar.gz`

### Information collated

This script collates the following information:

| Diagnostic                                   | Dependencies      | User |
|----------------------------------------------|-------------------|------|
| `/etc/os-release`                            | -                 | -    |
| `/etc/redhat-release`                        | -                 | -    |
| `uname -a` output                            | -                 | -    |
| Caplin `dfw versions` output                 | Binary is in a [DFW](https://www.caplin.com/developer/caplin-platform/deployment-framework/) | -    |
| Core file                                    | -                 | -    |
| Core file backtrace                          | `gdb` RPM package | -    |
| Core file libraries                          | `gdb` RPM package | -    |
| Component binary                             | -                 | -    |

### Example

The example below collates diagnostics for a core file, `core.4972`, dumped by a Liberator binary, `rttpd`:

```console
$ ./caplin-core-diagnostics.sh ~/dfw1/servers/Liberator/bin/rttpd ~/dfw1/servers/Liberator/core.4972

Caplin Core-file Diagnostics
============================

Script temp dir: diagnostics-server1-rttpd-core.4972-20190916104354

Recording /etc/os-release
Recording /etc/redhat-release
Recording 'uname -a' output
Recording 'dfw versions' output
Getting thread backtraces from core.4972
Getting list of libraries referenced by core.4972
Copying libraries referenced by core.4972

DONE

Files collected:

  core.4972
  core.4972.backtrace.out
  core.4972.libs.tar
  dfw-versions.out
  diagnostics.log
  libs-list.out
  libs-list.txt
  os-release
  redhat-release
  rttpd
  uname.out

Archiving files to diagnostics-server1-rttpd-core.4972-20190916104354.tar.gz

Please login to https://www.caplin.com/account/uploads
and upload the archive to Caplin Support.
```


## caplin-process-diagnostics.sh

Collates diagnostics for a running Caplin component, without terminating the component process.

The diagnostics collated include a core dump, thread backtraces, and JVM stack trace (if the component has a JVM). For the full list of information collated, see [Information collated](#information-collated-1), below.

After running the script, log in to Caplin's secure [File Upload Facility](https://www.caplin.com/account/uploads) and upload the following files:

*   Tar archive generated by the `caplin-process-diagnostics.sh` script
*   Java virtual machine log files (if available):
    *   Garbage collection log (`var/gc.log`)
*   Caplin log files for the period of the incident
*   Caplin configuration files

### Requirements

The most useful diagnostics require the GNU Debugger to be installed (`gdb` RPM package).


**Mandatory requirements**:

*   [CentOS](https://www.centos.org/)/[RHEL](https://www.redhat.com/en/technologies/linux-platforms/enterprise-linux) 6 or 7
*   Write permission to the current directory

**Optional requirements**:

*   `gdb` RPM package installed. Required for GDB backtraces and GDB core dump. **Recommended**.
*   `jcmd` JDK utility in your executable path. Required for JVM diagnostics. **Recommended**.
*   Free disk space greater than the process's virtual memory. Required for the GDB core dump.
*   `strace` RPM package installed. Only required if requested by Caplin Support.

### Usage

**Syntax**: `caplin-process-diagnostics.sh [options] pid`

*   `pid`: process identifier of the running component
*   Options:
    *   `--jvm-heap-dump`: include the optional JVM heap dump diagnostic. Only include this diagnostic when requested by Caplin Support.
    *   `--jvm-class-histogram`: include the optional JVM class histogram diagnostic. Only include this diagnostic when requested by Caplin Support.
    *   `--strace`: include the optional `strace` diagnostic. Only include this diagnostic when requested by Caplin Support.
    *   `--help`: display help

**Run as**: the process's user or root. On CentOS/RHEL 7 systems, depending on the configuration of the [Yama kernel module](https://www.kernel.org/doc/Documentation/security/Yama.txt), the GNU Debugger (GDB) and `strace` diagnostics may require root privileges.

**Runtime**: 3-5 minutes (2 minutes + _core-dump execution and archival_)

**Output**: `diagnostics-<hostname>-<binary>-<pid>-<timestamp>.tar.gz`

### Information collated

Default diagnostics:

| Diagnostic                            | Dependencies         | User     |
|---------------------------------------|----------------------|----------|
| `/etc/os-release`                     | -                    | -        |
| `/etc/redhat-release`                 | -                    | -        |
| `uname -a` output                     | -                    | -        |
| `/proc/sys/kernel/core_pattern`       | -                    | -        |
| `/proc/sys/kernel/core_uses_pid`      | -                    | -        |
| `/proc/<pid>/limits`                  | -                    | -        |
| `top` output for the system (30 seconds)| -                    | -        |
| `top` output for the process (30 seconds)| -                    | -        |
| `df` output for the process's `<working-dir>/var` directory| - | -      |
| `free` output                         | -                    | -        |
| `vmstat` output (30 seconds)          | -                    | -        |
| Caplin `dfw info` output              | Process binary is in a [DFW](https://www.caplin.com/developer/caplin-platform/deployment-framework/)| -        |
| Caplin `dfw status` output            | Process binary is in a [DFW](https://www.caplin.com/developer/caplin-platform/deployment-framework/)| -        |
| Caplin `dfw versions` output          | Process binary is in a [DFW](https://www.caplin.com/developer/caplin-platform/deployment-framework/)| -        |
| JVM `jcmd <pid> Thread.print` output  | `jcmd` JDK command       | _Note 1_ |
| JVM `jcmd <pid> GC.heap_info` output  | `jcmd` JDK command       | _Note 1_ |
| JVM `jcmd <pid> VM.system_properties` output | `jcmd` JDK command| _Note 1_ |
| JVM `jcmd <pid> VM.flags` output      | `jcmd` JDK command       | _Note 1_ |
| JVM `jcmd <pid> PerfCounter.print` output | `jcmd` JDK command   | _Note 1_ |
| JVM `jstat -gc <pid>` output          | `jcmd` JDK command       | _Note 1_ |
| JVM `jstat -gcutil <pid>` output      | `jcmd` JDK command       | _Note 1_ |
| 3x GDB thread backtraces, 10 seconds apart| `gdb` RPM package    | _Note 2_ |
| GDB core-file dump                    | `gdb` RPM package    | _Note 2_ |
| Core-file backtrace                   | `gdb` RPM package    | -        |
| Core-file libraries                   | `gdb` RPM package    | -        |
| Process binary                        | -                    | -        |

Optional diagnostics (only enable if requested by Caplin Support):

| Diagnostic                            | Dependencies         | User     |
|---------------------------------------|----------------------|----------|
| JVM `jcmd <pid> GC.heap_dump` output  | `jcmd` JDK command   | _Note 1_ |
| JVM `jcmd <pid> GC.class_histogram` output  | `jcmd` JDK command| _Note 1_ |
| `strace` output (system-call logging) | `strace` RPM package | _Note 2_ |

**Note 1**: JVM diagnostics must be run as the process's user. If you run the script as root, then the script uses `sudo` to run the JVM diagnostics as the process's user.

**Note 2**: GDB thread backtraces, GDB core dump, and `strace` can be run as the process's user, unless prohibited by the [Yama kernel module](https://www.kernel.org/doc/Documentation/security/Yama.txt) (introduced in CentOS/RHEL 7). The script will advise you if root privileges are required to run these diagnostics.

### Performance impact

The default set of diagnostics includes only two diagnostics that directly impact the performance of the target process:

*   **3x GDB thread backtraces**: the target process is halted temporarily for less than 1 second for each backtrace.

*   **GDB core dump**: the target process is halted temporarily for the time it takes the [gcore](http://man7.org/linux/man-pages/man1/gcore.1.html) command to write the process's virtual memory to a core file. The execution time is determined by the size of the process's virtual memory (`ps -o vsz= -q <process-id>`) and the write performance of the host's I/O.

The optional diagnostics have a potentially greater performance impact and should only be enabled when requested by Caplin Support:

*   **strace**: slows performance of the target process for the duration of the diagnostic (40 seconds).

*   **JVM heap dump**: halts the JVM temporarily for the duration of the diagnostic.

*   **JVM class histogram**: halts the JVM temporarily for the duration of the diagnostic.

### Example

The example below collates diagnostics for a Liberator running as process 4972:

```console
$ ./caplin-process-diagnostics.sh 4972

Caplin Process Diagnostics
==========================

Process ID:      4972
Process binary:  /home/caplin/dfw1/kits/Liberator/Liberator-7.1.9-313149/bin/rttpd

Script user:     root
Script temp dir: ./diagnostics-server1-rttpd-4972-20190916102608

Recording /etc/os-release
Recording /etc/redhat-release
Recording 'uname -a' output
Recording /proc/sys/kernel/core_pattern
Recording /proc/sys/kernel/core_uses_pid
Recording /proc/4972/limits
Recording 'top' output (1 minute)
Recording 'top' output for process 4972 (1 minute)
Recording process 4972 limits (/proc/4972/limits)
Recording 'df' output for /home/caplin/dfw1/servers/Liberator/var
Recording 'free' output
Recording 'vmstat' output (30 seconds)
Recording 'dfw info' output
Recording 'dfw status' output
Recording 'dfw versions' output
1/3: Dumping GDB thread backtraces for process 4972
  Sleeping for 10 seconds...
2/3: Dumping GDB thread backtraces for process 4972
  Sleeping for 10 seconds...
3/3: Dumping GDB thread backtraces for process 4972
Recording JVM stack trace
Recording JVM heap info
Recording JVM properties
Recording JVM flags
Recording JVM performance counters
Recording JVM jstat GC output
Dumping GDB core file for process 4972
  Estimated core-file size: 2778MB
  Available disk space: 20770MB
  Core dumped to rttpd.core.4972
  Getting thread backtraces from rttpd.core.4972
  Getting list of libraries referenced by rttpd.core.4972
  Copying libraries referenced by rttpd.core.4972
Creating symbolic link to process's binary

DONE

Files collected:
  df.out
  dfw-info.out
  dfw-status.out
  dfw-versions.out
  diagnostics.log
  free.out
  jvm-flags
  jvm-heapinfo
  jvm-jstat-gc
  jvm-jstat-gcutil
  jvm-perfcounter
  jvm-props
  jvm-stacktrace
  libs-list.out
  libs-list.txt
  os-release
  proc-4972-limits
  proc-sys-kernel-core_pattern
  proc-sys-kernel-core_uses_pid
  redhat-release
  rttpd
  rttpd-backtrace-20190916102843.out
  rttpd-backtrace-20190916102854.out
  rttpd-backtrace-20190916102904.out
  rttpd.core.4972
  rttpd.core.4972.backtrace.out
  rttpd.core.4972.libs.tar
  top.out
  top-4972.out
  uname.out
  vmstat.out

Archiving files to diagnostics-server1-rttpd-4972-20190916102608.tar.gz

Please login to https://www.caplin.com/account/uploads
and upload the archive to Caplin Support.
```
